
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Sanjay Bhagia&#x27;s Blog - Paged Custom Search Query using KeywordQuery</title>
        <meta name="description" content="Sanjay Bhagia" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Sanjay Bhagia&#x27;s Blog" href="/rss.xml" />
                <link type="application/atom+xml" rel="alternate" title="Sanjay Bhagia&#x27;s Blog" href="/feed.xml" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Sanjay Bhagia&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Sanjay Bhagia&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:site_name" content="Sanjay Bhagia&#x27;s Blog" />
        <meta property="og:title" content="Paged Custom Search Query using KeywordQuery" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://sanjaybhagia.com/2013/03/paged-custom-search-query-using-keywordquery" />
                        <meta property="og:description" content="style=&quot;text-align:justify;&quot;&gt;SharePoint Server Object Model provides two classes to perform custom search queries namely &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.search.query.fulltextsqlquery(v=office.14).aspx&quot;&gt;FullTextSqlQuery &lt;/a&gt;and &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.search.query.keywordquery(v=office.14).aspx&quot;&gt;KeywordQuery&lt;/a&gt;. Both of these classes inherit from a generic Query class (in&amp;nbsp;&amp;nbsp;Microsoft.SharePoint.Search namespace)." />

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/highlight.pack.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/please-compressed.js"></script>
        <!-- <script src="/assets/js/background-check.min.js"></script> -->
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->
        
        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Sanjay Bhagia&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                <li><a href="/about">About Me</a></li>
<li><a href="/posts">Archive</a></li>
<li><a href="/tags">Tags</a></li>
<li><a href="/tools">Tools</a></li> 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Paged Custom Search Query using KeywordQuery</h1>
    <div class="meta">        
Published on Thursday, 14 March 2013<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/custom-search" class="btn btn-default btn-xs">Custom Search</a>
                    <a role="button" href="/tags/keywordquery" class="btn btn-default btn-xs">KeywordQuery</a>
                    <a role="button" href="/tags/people-search" class="btn btn-default btn-xs">People Search</a>
                    <a role="button" href="/tags/relevantresults" class="btn btn-default btn-xs">RelevantResults</a>
                    <a role="button" href="/tags/resulttable" class="btn btn-default btn-xs">ResultTable</a>
                    <a role="button" href="/tags/search" class="btn btn-default btn-xs">Search</a>
                    <a role="button" href="/tags/sharepoint-search" class="btn btn-default btn-xs">SharePoint Search</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p style="text-align:justify;">SharePoint Server Object Model provides two classes to perform custom search queries namely <a href="http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.search.query.fulltextsqlquery(v=office.14).aspx">FullTextSqlQuery </a>and <a href="http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.search.query.keywordquery(v=office.14).aspx">KeywordQuery</a>. Both of these classes inherit from a generic Query class (in  Microsoft.SharePoint.Search namespace).</p>
<p style="text-align:justify;">You can perform search operations using both of these classes depending on your needs as FullTextSqlQuery provides more sophisticated queries using Sql syntax whereas KeywordQuery class provides simpler syntax to do the search.</p>
<p style="text-align:justify;">However, the scenario I'm explaining in this post is relevant to both of these classes but i will use KeywordQuery class to demonstrate.</p>
<p style="text-align:justify;">Scenario:</p>
<p style="text-align:justify;">I want to write a custom people search web part that takes in the keywords entered by user and performs the search.</p>
<p style="text-align:justify;"><em>I'm using powershell to demonstrate here but this can be done in C# as well in similar fashion.</em></p>
<p style="text-align:justify;">So, here is the function that performs the basic search</p>
<pre><code class="ps">
Function GetSearchResults([string]$siteCollectionUrl, [string]$keyword, [int]$sIndex, [int]$rLimit)
{
	#load the site and set the keyword query object
	$searchSite = Get-SPSite $siteCollectionUrl

	$keywordQuery = New-Object Microsoft.Office.Server.Search.Query.KeywordQuery $searchSite

	$keywordQuery.ResultTypes = [Microsoft.Office.Server.Search.Query.ResultType]::RelevantResults

  	#Write-Host &quot;Start Index &quot; $sIndex
	#Write-Host &quot;Row Limit &quot; $rLimit
	#Write-Host &quot;Keyword &quot; $keyword

	$keywordQuery.StartRow = $sIndex
	$keywordQuery.RowLimit = $rLimit
	$keywordQuery.HiddenConstraints = &quot;scope:People&quot;

	#Pass the query text - SharePoint
	$keywordQuery.QueryText = $keyword

	#query execution
	$results = $keywordQuery.Execute()
	return $results
}
</code></pre>
<p style="text-align:justify;">KeywordQuery class has two properties (RowLimit and StartRow) that are of our interest here.
<strong>RowLimit</strong> specifies the number of items that you want the search to return when you execute the query
and <strong>StartRow</strong> gets or sets the first row of information from the search results. So basically with both of these properties you get the paged search result instead of getting entire data in one chunk !</p>
<p style="text-align:justify;">Now, one of the obvious reasons to do this performance. But there is one more reason as well. RowLimit (<em>default value is 50 if you don't specify it yourself</em>), even though can accept maximum 32-bit integer value theoretically, is set to some hardcoded limit of 10000. It means that if you set RowLimit to anything greater that 10000 you will get an exception when you execute the query.</p>
<p style="text-align:justify;">The exception is something like this:</p>
<pre>"Exception from HRESULT: 0x80040E01"</pre>
<p>Here is the StackTrace from ULS log:</p>
<pre><code class="">Log Query: More Information: Row could not be inserted into the rowset without exceeding provider's maximum number of active rows.

SearchServiceApplication::Execute--Exception: System.Runtime.InteropServices.COMException (0x80040E01): Exception from HRESULT: 0x80040E01
at System.Runtime.InteropServices.Marshal.ThrowExceptionForHRInternal(Int32 errorCode, IntPtr errorInfo)
at Microsoft.Office.Server.Search.Query.KeywordQueryInternal.Execute()
at Microsoft.Office.Server.Search.Query.QueryInternal.Execute(QueryProperties properties)
at Microsoft.Office.Server.Search.Administration.SearchServiceApplication.Execute(QueryProperties properties)

SearchServiceApplicationProxy::Execute--Error occured: System.ServiceModel.FaultException`1[System.ServiceModel.ExceptionDetail]:
Exception from HRESULT: 0x80040E01 (Fault Detail is equal to An ExceptionDetail, likely created by IncludeExceptionDetailInFaults=true,
whose value is: System.Runtime.InteropServices.COMException: Exception from HRESULT: 0x80040E01
at System.Runtime.InteropServices.Marshal.ThrowExceptionForHRInternal(Int32 errorCode, IntPtr errorInfo)
at Microsoft.Office.Server.Search.Query.KeywordQueryInternal.Execute()
at Microsoft.Office.Server.Search.Query.QueryInternal.Execute(QueryProperties properties)
at Microsoft.Office.Server.Search.Administration.SearchServiceApplication.Execute(QueryProperties properties)
at SyncInvokeExecute(Object , Object[] , Object[] )
at System.ServiceModel.Dispatcher.SyncMethodInvoker.Invoke(Object instance, Object[] inputs, Object[]&amp; outputs)
at System.ServiceModel.Dispatcher.DispatchOperationRuntime.InvokeBegin(MessageRpc&amp; rpc)
at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage5(MessageRpc&amp; rpc)
at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage4(MessageRpc&amp; rpc) ...).</code></pre>
<p>You can determine this limit by this method in your environment.</p>
<pre><code class="ps"># Get the maximum results returned value set for KeywordQuery and FullTextQuery in current environment
Function GetMaxResultsReturned()
{
 # Get reference to Search Service Application
 $ssa = Get-SPEnterpriseSearchServiceApplication
 return $ssa.GetSetting('Config:qp_MaxResultsReturned')
}
</code></pre>
<p>This value is configured at Search Service Application level. Now this could be different for your environment but default is 10000. So if you set RowLimit to anything greater than this value ('Config:qp_MaxResultsReturned') you will get an exception.
You can modify this value if you want using this function</p>
<pre><code class="ps"># Sets the maximum results returned value set for KeywordQuery and FullTextQuery in current environment
Function SetMaxResultsReturned($newLimit)
{
	$ssa = Get-SPEnterpriseSearchServiceApplication
	$ssa.UpdateSetting('Config:qp_MaxResultsReturned', $newLimit)
	$ssa.Update()
}
</code></pre>
<p style="text-align:justify;">So, in order to avoid this exception, you should query to retrieve results in chunks and then merge them. In this way you don't loose on performance and also you will get your results back without facing this exception.</p>
<p style="text-align:justify;">Following, I'm calling the GetSearchResults function (defined above) to perform people search query by retrieving results in pages and merging them in a DataTable.</p>
<pre><code class="ps">
$startIndex = 0
$rowLimit = 50
$siteCollectionUrl = &quot;&lt;Url of the site collection&gt;&quot;
$searchKey = &quot;s*&quot;

$resultCollection = GetSearchResults $siteCollectionUrl $searchKey $startIndex $rowLimit
$hits = $resultCollection.TotalRows
Write-Host Total hits: $hits
$resultsDataTable = $resultCollection.Table

#Iterate through the rest of the pages to fetch items
while($resultCollection.TotalRows -gt $resultsDataTable.Rows.Count)
{
	$sIndex = $resultsDataTable.Rows.Count
	$resultCollection = GetSearchResults $searchKey $startIndex $rowLimit
        $resultsDataTable.Load($resultCollection, [System.Data.LoadOption]::PreserveChanges)
}

# display the results in table format for better view
$resultsDataTable | Format-Table -AutoSize -Property title , url
</code></pre>
<p>Hope it helps!</p>


<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'sanjaybhagia';
    var disqus_identifier = 'paged-custom-search-query-using-keywordquery';
    var disqus_title = 'Paged Custom Search Query using KeywordQuery';
    var disqus_url = 'http://sanjaybhagia.com/2013/03/paged-custom-search-query-using-keywordquery';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12">
                <ul class="list-inline text-center">
                        <li>
                        <a href="https://twitter.com/bhagiasanjay">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                        <li>
                        <a href="https://github.com/sanjaybhagia">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                        <li>
                        <a href="https://www.linkedin.com/in/sanjaybhagia/">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                </ul>
                <p class="copyright text-muted">                        
                        This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                        <br />
                        <a href="/rss.xml"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.xml"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <a href="https://github.com/sanjaybhagia/sanjaybhagia.com"><i class="fa fa-github"></i> This Site on GitHub</a> | <a href="https://wyam.io">Generated by Wyam</a>
                </p>
                </div>
        </div>
</div>
                </footer> 

                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>
        </body>
</html>
