
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Sanjay Bhagia&#x27;s Blog - Incorrect values for User Fields while copying list items from one site collection to another</title>
        <meta name="description" content="Sanjay Bhagia" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Sanjay Bhagia&#x27;s Blog" href="/rss.xml" />
                <link type="application/atom+xml" rel="alternate" title="Sanjay Bhagia&#x27;s Blog" href="/feed.xml" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Sanjay Bhagia&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Sanjay Bhagia&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:site_name" content="Sanjay Bhagia&#x27;s Blog" />
        <meta property="og:title" content="Incorrect values for User Fields while copying list items from one site collection to another" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://sanjaybhagia.com/2013/05/incorrect-values-for-user-fields-while-copying-list-items-from-one-site-collection-to-another" />
                        <meta property="og:description" content="&lt;strong&gt;Scenario&lt;/strong&gt;" />

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/highlight.pack.js"></script>
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/please-compressed.js"></script>
        <!-- <script src="/assets/js/background-check.min.js"></script> -->
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->
        
        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Sanjay Bhagia&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                <li><a href="/about">About Me</a></li>
<li><a href="/posts">Archive</a></li>
<li><a href="/tags">Tags</a></li>
<li><a href="/tools">Tools</a></li> 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Incorrect values for User Fields while copying list items from one site collection to another</h1>
    <div class="meta">        
Published on Saturday, 25 May 2013<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/copy-list-item" class="btn btn-default btn-xs">Copy list item</a>
                    <a role="button" href="/tags/cross-site-collection" class="btn btn-default btn-xs">Cross Site Collection</a>
                    <a role="button" href="/tags/list-items" class="btn btn-default btn-xs">List Items</a>
                    <a role="button" href="/tags/spfielduser" class="btn btn-default btn-xs">SPFieldUser</a>
                    <a role="button" href="/tags/spfielduservalue" class="btn btn-default btn-xs">SPFieldUserValue</a>
                    <a role="button" href="/tags/user-fields" class="btn btn-default btn-xs">User Fields</a>
                    <a role="button" href="/tags/user-information-list" class="btn btn-default btn-xs">User Information List</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p><strong>Scenario</strong></p>
<p style="text-align:justify;">Recently, I was writting a piece of code to copy list item from a list in one site collection to the list in another site collection. I did the shallow copy (copying field by field).
Both the lists were created using same List definition so they had same fields and content types etc.
The item was successfully copied but then I noticed that the values of user fields were not correct.</p>
<p style="text-align:justify;">Here is the pice of code that i used for copying the item</p>
<pre><code class="csharp">
Public static void Main(string[] args)
{
    using (SPSite sourceSite = new SPSite(&quot;http://sp2010demo/sites/source&quot;))
    {
      using (SPWeb web = sourceSite .OpenWeb())
      {
          SPList sourceList= web.Lists.TryGetList(&quot;Source List&quot;);
          //fetch first item - for demonstration purpose
          SPListItem sourceItem = sourceList.Items[0];
          //instantiate destination site collection
          using (SPSite destinationSite = new SPSite(&quot;http://sp2010demo/sites/destination/&quot;))
          {
             var destinationList = destinationSite.RootWeb.Lists.TryGetList(&quot;DestinationList&quot;);
             if (destinationList != null)
             {
                //Add new item
                SPListItem destinationItem = destinationList.Items.Add();
                //copy item
                CopyListItem(sourceItem, destinationItem);
             }
          }
      }
   }
}

public static void CopyListItem(SPListItem sourceItem, SPListItem destinationItem)
{
        foreach (SPField field in sourceItem.Fields)
        { 
          //Filter out readonly and attachment fields
          if ((!field.ReadOnlyField) &amp;amp;&amp;amp; (field.InternalName != &quot;Attachments&quot;))
          {
                destinationItem[field.Title] = sourceItem[field.Title];
          }
        } 
        destinationItem.Update();
}
</code></pre>
<p style="text-align:justify;">Apparently, it looked just fine and i used the same piece of code to copy the list items from one list to another within the same site collection and it worked just perfect as it should !</p>
<p style="text-align:justify;"><strong>Problem</strong></p>
<p style="text-align:justify;">So, the problem was actually that when you move this item to a different site collection, users have to be present there in order for it to have the correct value.</p>
<p style="text-align:justify;">If you look at the internal representation of the user field it is basically a look up value and the value is represented something like this: <strong>1;#Sanjay Bhagia</strong></p>
<p style="text-align:left;">Where first number is the user id in User Information List in the site collection that can be accessed (only if you are admin) by navigating to the following url in your site <strong>_catalogs/users/simple.aspx</strong> (e.g., http://sp2010demo/sites/source/_catalogs/users/simple.aspx).</p>
<p style="text-align:justify;">So lets do some investigation.</p>
<p style="text-align:left;">I first open my source site collection i.e., http://sp2010demo/sites/source and navigate to my user information list by navigating to the following url http://sp2010demo/sites/source_catalogs/users/simple.aspx It shows all the users that have been added in my site</p>
<p style="text-align:justify;"><a href="/images/userinfosourcesite1.jpg"><img class="alignnone size-full wp-image-265" alt="userinfosourcesite" src="/images/userinfosourcesite1.jpg" width="600" height="105" /></a></p>
<p style="text-align:justify;">Now, if you put the cursor on the user link, you can see the entire url in the status bar of your browser. At the end of the url you can see the querystring <strong>ID </strong>that has value 1 in this example.</p>
<p style="text-align:justify;">Now lets navigate to the same user list in destination site collection by (http://sp2010demo/sites/destination/_catalog/users/simple.aspx).</p>
<p style="text-align:justify;">Note: In my environment, I already have my user added in both the site collections, that is why I'm able to see my user at both the places but it is possible that you don't see any user at both the places. User will be added automatically if you have logged in with that user on that site</p>
<p style="text-align:justify;"><a href="/images/userinfodestination1.jpg"><img class="alignnone size-full wp-image-266" alt="userinfodestination" src="/images/userinfodestination1.jpg" width="600" height="105" /></a></p>
<p style="text-align:justify;">By observing the url of the same user we can see that the user id for this user in destination site collection is <strong>10</strong>.</p>
<p style="text-align:justify;">So if I'm copying the list item that has user field and that field has my user added (i.e., Sanjay Bhagia) the representation of that user in my source site collection will be <strong>1;#Sanjay Bhagia</strong> but the representation of the same user in my destination site collection will be <strong>10;#Sanjay Bhagia</strong> !! Hence, the copied item will not display the proper user at the destination list item.</p>
<p style="text-align:justify;"><strong>Solution</strong>
It is quite easy to fix this issue, I basically fetched the value from user field and called SPWeb.EnsureUser() method to make sure the user is added in the User Information List in my destination site collection and updated the LookupId attribute of the SPUser object.</p>
<p style="text-align:justify;">Here is the modified code:</p>
<pre><code class="csharp">
public static void CopyListItem(SPListItem sourceItem, SPListItem destinationItem)
{
    foreach (SPField field in sourceItem.Fields)
    {
        //Filter out readonly and attachment fields
	if ((!field.ReadOnlyField) &amp;&amp; (field.InternalName != &quot;Attachments&quot;))
        {
            //only for user type fields
            if (field.GetType() == typeof(SPFieldUser))
            {
               SPWeb destinationParentWeb = destinationItem.ParentList.ParentWeb;
               if (sourceItem[field.Title] != null)
               {
                 //for field can have multiple selection enabled otherwise you can user SPFieldUserValue class
                 SPFieldUserValueCollection users = new SPFieldUserValueCollection(sourceItem.ParentList.ParentWeb, sourceItem[field.Title].ToString());
                 foreach (SPFieldUserValue user in users)
                 {
                    //this LookupId is the number of user object in User Information List
                    user.LookupId = destinationParentWeb.EnsureUser(user.User.LoginName).ID;
                 }
                destinationItem[field.Title] = users;
               }
            }
            else
              destinationItem[field.Title] = sourceItem[field.Title];
                    }
        }
    destinationItem.Update();
}
</code></pre>
<p>So basically, I'm making sure that user object in destination site collection has the correct look up id, that's it!</p>
<p>Hope it helps.</p>


<div id="disqus_thread"></div>

<script type="text/javascript">
    var disqus_shortname = 'sanjaybhagia';
    var disqus_identifier = 'incorrect-values-for-user-fields-while-copying-list-items-from-one-site-collection-to-another';
    var disqus_title = 'Incorrect values for User Fields while copying list items from one site collection to another';
    var disqus_url = 'http://sanjaybhagia.com/2013/05/incorrect-values-for-user-fields-while-copying-list-items-from-one-site-collection-to-another';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12">
                <ul class="list-inline text-center">
                        <li>
                        <a href="https://twitter.com/bhagiasanjay">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                        <li>
                        <a href="https://github.com/sanjaybhagia">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                        <li>
                        <a href="https://www.linkedin.com/in/sanjaybhagia/">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                </ul>
                <p class="copyright text-muted">                        
                        This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                        <br />
                        <a href="/rss.xml"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.xml"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <a href="https://github.com/sanjaybhagia/sanjaybhagia.com"><i class="fa fa-github"></i> This Site on GitHub</a> | <a href="https://wyam.io">Generated by Wyam</a>
                </p>
                </div>
        </div>
</div>
                </footer> 

                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>
        </body>
</html>
